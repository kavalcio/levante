{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Nominate - levant√©!</title>
    <link rel="stylesheet" href="{% static 'nominate.css' %}">
</head>

<body>
    <h1 id="nominate-header">Nominate Ideas </h1>
    <input id="problem-description" type="text" size="100" >
    <input type="image" name="don't nomniate" id="left-button" value="hey" src="{% static 'images/right-thumb.png' %}" onclick="dontNominateIdea()">
    <div id="main-container">
        <input type="text" id="idea-current" value="idea will appear here"></input>
    </div>
    <input type="image" name="nominate" id="right-button" src="{% static 'images/left-thumb.png' %}" onclick="nominateIdea()">

    <div class="meter">
        <span style="width: 25%"></span>
    </div>



    {{ user_name|json_script:"user-name" }}


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
        var token = '{{csrf_token}}';
        const user = JSON.parse(document.getElementById('user-name').textContent);

        //Get problem description
        $.ajax({
            type: 'GET',
            headers: { "X-CSRFToken": token },
            url: '/get_question/',
            data: {
                room_id: localStorage.getItem('roomId')
            },
            success: function (response) {
                document.querySelector('#problem-description').value = response;
            },
        });
        loadNextIdea()
        //loads the next idea from the db and navigates to the next page if no more ideas are available
        function loadNextIdea(){
            const roomId = localStorage.getItem('roomId');
            $.ajax({
                type: 'GET',
                headers: { "X-CSRFToken": token },
                url: '/get_responses/',
                data: {
                    page: 'nominate',
                    room_id: roomId,
                },
                success: function(response) {
                    //forward to voting if all ideas have been nominated                        
                    if (response == "NULL869" || response == "None") {
                        $.ajax({
                            type: 'POST',
                            url: '/reset_responses/',
                            success: function (response) {
                                
                            },
                        });
                        window.location.pathname = window.location.pathname.split("nominate")[0] + 'development/';
                    } else {
                        const ideas = JSON.parse(response);
                        currentIdea =  ideas[0].fields.response_text;
                        document.getElementById("idea-current").value = currentIdea;
                    }
                },
            });
        }
        //updates the nomination parameter of the response and loads the next idea
        function nominateIdea(){
            const idea = document.querySelector('#idea-current').value;
            $.ajax({
                type: 'POST',
                headers: { "X-CSRFToken": token },
                url: '/upd_response/',
                data: {
                    response: idea,
                    check: "nominate"
                },
                success: function (response) {
                    
                },
            });
            loadNextIdea()
        }

        //updates the nomination parameter of the response and loads the next idea
        function dontNominateIdea() {
            const idea = document.querySelector('#idea-current').value;
            $.ajax({
                type: 'POST',
                headers: { "X-CSRFToken": token },
                url: '/upd_response/',
                data: {
                    response: idea,
                    check: "no"
                },
                success: function (response) {
                    
                },
            });
            loadNextIdea()
        }
    </script>
</body>
</html>