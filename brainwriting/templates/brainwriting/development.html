{% load static %}
<html>
<head>

    <head>
        <meta charset="utf-8" />
        <title>Development - levant√©!</title>
        <link rel="stylesheet" href="{% static 'developement.css' %}">
    </head>
</head>
<body>
    <h2>Develop Ideas!</h2><br>
    <input id="problem-description" type="text" size="100" ><br>
    <input type="text" id="current-idea" ></input><br>
    <input id="comment-text-input" type="text" size="100"><br>
    <button onclick="loadNextIdea()">Next Idea</button>
    <button onclick="submitComment()">Submit</button>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
        var token = '{{csrf_token}}';
        //Get problem description
        $.ajax({
            type: 'GET',
            headers: { "X-CSRFToken": token },
            url: '/get_question/',
            data: {
                room_id: localStorage.getItem('roomId')
            },
            success: function (response) {
                document.querySelector('#problem-description').value = response;
            },
        });

        let currentIdea = null;
        let ideas = null;
        let count = 0;
        init();

        async function init() {
            ideas = await getIdeas();
            ideas = JSON.parse(ideas);
            length = Object.keys(ideas).length;
            loadNextIdea();
        }
        function getIdeas() {
            const roomId = localStorage.getItem('roomId');
            return $.ajax({
                type: 'GET',
                headers: { "X-CSRFToken": token },
                url: '/get_responses/',
                data: {
                    page: 'development',
                    room_id: roomId,
                },
                success: function(response) {
                    if (response == "NULL869" || response == "none")
                    {
                        return;
                    }
                    return response;
                },
            });
        }
        function loadNextIdea() {
            for(i=0+count;i<ideas.length;i++){
                var ideaObj = ideas[i];
                if(ideaObj.fields.check == 1){
                    continue;
                }
                else if (ideaObj.fields.check == 0){
                    //ensures we skip the ideas that have already been checked
                    count = i
                    break
                }
            }
            if(ideaObj.fields.check == 1)
                window.location.pathname = window.location.pathname.split("development")[0] + 'voting/';
            
            
            currentIdea = ideaObj.fields.response_text;
            document.getElementById("current-idea").value = currentIdea;
            ideaObj.fields.check = 1
            $.ajax({
                type: 'GET',
                headers: { "X-CSRFToken": token },
                url: '/get_comments/',
                data: {
                    response_id: ideaObj.pk,
                },
                success: function (result) {
                    const comments = JSON.parse(result);
                    for (index in comments) {
                        document.getElementById("current-idea").value += '\n' + comments[index];
                    }
                },
            });
        }

        function submitComment() {
            comment = document.getElementById("comment-text-input").value;
            document.getElementById("current-idea").value += '\n' + comment;

            $.ajax({
                type: 'POST',
                headers: { "X-CSRFToken": token },
                url: '/add_comment/',
                data: {
                    idea: currentIdea,
                    comment: comment,
                },
                success: function (response) {
                    document.getElementById("comment-text-input").value = response;
                },
            });
        }
    </script>
</body>
</html>