{% load static %}
<html>
<head>
    <meta charset="utf-8" />
    <title>Poopoo Room</title>
    <link rel="stylesheet" href="{% static 'developement.css' %}">
</head>
<body>
    <h2>Develop Ideas!</h2><br>
    <input type="text" id="current-idea" ></input><br>
    <input id="comment-text-input" type="text" size="100"><br>
    <button onclick="loadNextIdea()">Next Idea</button>
    <button onclick="submitComment()">Submit</button>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
        var token = '{{csrf_token}}';
        let currentIdea = null;
        let ideas = null;
        init();

        async function init() {
            ideas = await getIdeas();
            ideas = JSON.parse(ideas);
            loadNextIdea(true);
        }
        function getIdeas() {
            const roomId = localStorage.getItem('roomId');
            return $.ajax({
                type: 'GET',
                headers: { "X-CSRFToken": token },
                url: '/get_responses/',
                data: {
                    page: 'inspiration',
                    room_id: roomId,
                },
                success: function(response) {
                    if (response == "NULL869" || response == "none")
                    {
                        return;
                    }
                    return response;
                },
            });
        }
        function loadNextIdea(firstRun) {
            const ideaObj = ideas[Math.floor(Math.random() * ideas.length)];
            currentIdea = ideaObj.fields.response_text;
            $.ajax({
                type: 'GET',
                headers: { "X-CSRFToken": token },
                url: '/get_comments/',
                data: {
                    response_id: ideaObj.pk,
                },
                success: function (result) {
                    const comments = JSON.parse(result);

                    if(result == "NULL869" || result == "none") {
                        //Reset checks on all objects
                        $.ajax({
                            type: 'POST',
                            url: '/reset_responses/',
                            success: function(response) {
                                alert(response);
                            },
                        });
                        window.location.pathname = window.location.pathname.split("development")[0] + 'voting/';
                    } else {
                        document.getElementById("current-idea").value = currentIdea;
                        for (index in comments) {
                            document.getElementById("current-idea").value += '\n' + comments[index];
                        }
                    }
                },
            });
            if (firstRun == false) {
                ideaDeveloped();
            }
        }
        function ideaDeveloped() {
            const idea = document.querySelector('#current-idea').value;
            $.ajax({
                type: 'POST',
                headers: { "X-CSRFToken": token },
                url: '/upd_response/',
                data: {
                    response: idea,
                    check: "yes"
                },
                success: function (response) {
                    alert(response);
                },
            });
        }
        function submitComment() {
            comment = document.getElementById("comment-text-input").value;
            document.getElementById("current-idea").value += '\n' + comment;

            $.ajax({
                type: 'POST',
                headers: { "X-CSRFToken": token },
                url: '/add_comment/',
                data: {
                    idea: currentIdea,
                    comment: comment,
                },
                success: function (response) {
                    document.getElementById("comment-text-input").value = response;
                },
            });
        }
    </script>
</body>
</html>